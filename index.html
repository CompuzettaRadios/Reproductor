<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Debug Icecast Info</title>
</head>
<body>
  <h2>Debug Icecast Metadata</h2>
  <input type="text" id="urlInput" placeholder="Ingresa URL base ej: https://cast6.my-control-panel.com/proxy/manrique/" size="80">
  <button onclick="debugInfo()">Analizar</button>
  <pre id="output"></pre>

  <script>
    async function fetchJSON(url) {
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      } catch (e) {
        return { error: e.message };
      }
    }

    async function fetchText(url) {
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.text();
      } catch (e) {
        return { error: e.message };
      }
    }

    function analyzeJSON(data) {
      if (data.error) return null;
      const srcs = Array.isArray(data.icestats?.source) ? data.icestats.source : [data.icestats?.source];
      for (const src of srcs) {
        if (src?.title || src?.yp_currently_playing) {
          return {
            type: "json",
            title: src.title || src.yp_currently_playing,
            listeners: src.listeners,
            bitrate: src.bitrate,
            server_name: src.server_name
          };
        }
      }
      return null;
    }

    function analyzeHTML(html) {
      if (!html || typeof html !== "string") return null;
      const titleMatch = html.match(/<title>(.*?)<\/title>/i);
      return titleMatch ? { type: "html", html_title: titleMatch[1] } : null;
    }

    async function debugInfo() {
      const baseUrl = document.getElementById("urlInput").value.trim().replace(/\/+$/, "");
      const jsonUrl = `${baseUrl}/status-json.xsl`;
      const htmlUrl = `${baseUrl}/status.xsl`;
      const out = document.getElementById("output");
      out.textContent = "üîç Consultando...";

      const [jsonData, htmlData] = await Promise.all([fetchJSON(jsonUrl), fetchText(htmlUrl)]);

      const jsonResult = analyzeJSON(jsonData);
      const htmlResult = analyzeHTML(htmlData);

      let report = "";

      if (jsonResult) {
        report += `‚úÖ JSON v√°lido:\nT√≠tulo: ${jsonResult.title}\nOyentes: ${jsonResult.listeners}\nBitrate: ${jsonResult.bitrate}\nNombre del servidor: ${jsonResult.server_name}\n\n`;
      } else {
        report += `‚ùå JSON inv√°lido o sin metadatos v√°lidos.\n`;
        if (jsonData?.error) report += `Error: ${jsonData.error}\n\n`;
      }

      if (htmlResult) {
        report += `‚úÖ HTML v√°lido:\nHTML Title: ${htmlResult.html_title}\n`;
      } else {
        report += `‚ùå HTML inv√°lido o sin t√≠tulo.\n`;
      }

      out.textContent = report;
    }
  </script>
</body>
</html>
